<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sqlite3_to_mysql.transporter &#8212; sqlite3-to-mysql 2.5.5 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=27fed22d" />
    <script src="../../_static/documentation_options.js?v=644f8b71"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sqlite3_to_mysql.transporter</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Use to transfer an SQLite 3 database to MySQL.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">t</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os.path</span><span class="w"> </span><span class="kn">import</span> <span class="n">isfile</span><span class="p">,</span> <span class="n">realpath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="kn">import</span> <span class="n">stdout</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">mysql.connector</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlglot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mysql.connector</span><span class="w"> </span><span class="kn">import</span> <span class="n">CharacterSet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mysql.connector</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">mysql_connector_version_string</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mysql.connector</span><span class="w"> </span><span class="kn">import</span> <span class="n">errorcode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlglot</span><span class="w"> </span><span class="kn">import</span> <span class="n">errors</span> <span class="k">as</span> <span class="n">sqlglot_errors</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlglot</span><span class="w"> </span><span class="kn">import</span> <span class="n">expressions</span> <span class="k">as</span> <span class="n">exp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlglot.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">mysql</span> <span class="k">as</span> <span class="n">sqlglot_mysql</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlglot.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_time</span> <span class="k">as</span> <span class="n">sqlglot_format_time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlglot.trie</span><span class="w"> </span><span class="kn">import</span> <span class="n">new_trie</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Python 3.11+</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Unpack</span>  <span class="c1"># type: ignore[attr-defined]</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Python &lt; 3.11</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Unpack</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlite3_to_mysql.sqlite_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">adapt_decimal</span><span class="p">,</span>
    <span class="n">adapt_timedelta</span><span class="p">,</span>
    <span class="n">check_sqlite_jsonb_support</span><span class="p">,</span>
    <span class="n">check_sqlite_table_xinfo_support</span><span class="p">,</span>
    <span class="n">convert_date</span><span class="p">,</span>
    <span class="n">convert_decimal</span><span class="p">,</span>
    <span class="n">convert_timedelta</span><span class="p">,</span>
    <span class="n">sqlite_jsonb_column_expression</span><span class="p">,</span>
    <span class="n">unicase_compare</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.mysql_utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MYSQL_BLOB_COLUMN_TYPES</span><span class="p">,</span>
    <span class="n">MYSQL_COLUMN_TYPES</span><span class="p">,</span>
    <span class="n">MYSQL_INSERT_METHOD</span><span class="p">,</span>
    <span class="n">MYSQL_TEXT_COLUMN_TYPES</span><span class="p">,</span>
    <span class="n">MYSQL_TEXT_COLUMN_TYPES_WITH_JSON</span><span class="p">,</span>
    <span class="n">check_mysql_current_timestamp_datetime_support</span><span class="p">,</span>
    <span class="n">check_mysql_expression_defaults_support</span><span class="p">,</span>
    <span class="n">check_mysql_fractional_seconds_support</span><span class="p">,</span>
    <span class="n">check_mysql_fulltext_support</span><span class="p">,</span>
    <span class="n">check_mysql_json_support</span><span class="p">,</span>
    <span class="n">check_mysql_values_alias_support</span><span class="p">,</span>
    <span class="n">safe_identifier_length</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">SQLite3toMySQLAttributes</span><span class="p">,</span> <span class="n">SQLite3toMySQLParams</span>


<span class="n">SQLGLOT_MYSQL_INVERSE_TIME_MAPPING</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sqlglot_mysql</span><span class="o">.</span><span class="n">MySQL</span><span class="o">.</span><span class="n">INVERSE_TIME_MAPPING</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;%H:%M:%S&quot;</span>
<span class="p">}</span>
<span class="n">SQLGLOT_MYSQL_INVERSE_TIME_TRIE</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_trie</span><span class="p">(</span><span class="n">SQLGLOT_MYSQL_INVERSE_TIME_MAPPING</span><span class="p">)</span>


<div class="viewcode-block" id="SQLite3toMySQL">
<a class="viewcode-back" href="../../sqlite3_to_mysql.html#sqlite3_to_mysql.transporter.SQLite3toMySQL">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SQLite3toMySQL</span><span class="p">(</span><span class="n">SQLite3toMySQLAttributes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Use this class to transfer an SQLite 3 database to MySQL.&quot;&quot;&quot;</span>

    <span class="n">COLUMN_PATTERN</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^(]+&quot;</span><span class="p">)</span>
    <span class="n">COLUMN_LENGTH_PATTERN</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(\d+\)&quot;</span><span class="p">)</span>
    <span class="n">COLUMN_PRECISION_AND_SCALE_PATTERN</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(\d+,\d+\)&quot;</span><span class="p">)</span>
    <span class="n">COLUMN_UNSIGNED_PATTERN</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bUNSIGNED\b&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">CURRENT_TS</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^CURRENT_TIMESTAMP(?:\s*\(\s*\))?$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">CURRENT_DATE</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^CURRENT_DATE(?:\s*\(\s*\))?$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">CURRENT_TIME</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^CURRENT_TIME(?:\s*\(\s*\))?$&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">SQLITE_NOW_FUNC</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^(datetime|date|time)\s*\(\s*&#39;now&#39;(?:\s*,\s*&#39;(localtime|utc)&#39;)?\s*\)$&quot;</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SQLITE_CURRENT_TS_FUNC</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^(datetime|date|time)\s*\(\s*current_timestamp(?:\s*,\s*&#39;(localtime|utc)&#39;)?\s*\)$&quot;</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">STRFTIME_NOW</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^strftime\s*\(\s*&#39;([^&#39;]+)&#39;\s*,\s*&#39;now&#39;(?:\s*,\s*&#39;(localtime|utc)&#39;)?\s*\)$&quot;</span><span class="p">,</span>
        <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">NUMERIC_LITERAL_PATTERN</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[+-]?(?:\d+(?:\.\d*)?|\.\d+)(?:[eE][+-]?\d+)?$&quot;</span><span class="p">)</span>

    <span class="n">MYSQL_CONNECTOR_VERSION</span><span class="p">:</span> <span class="n">version</span><span class="o">.</span><span class="n">Version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">mysql_connector_version_string</span><span class="p">)</span>

<div class="viewcode-block" id="SQLite3toMySQL.__init__">
<a class="viewcode-back" href="../../sqlite3_to_mysql.html#sqlite3_to_mysql.transporter.SQLite3toMySQL.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">SQLite3toMySQLParams</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sqlite_file&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide an SQLite file&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sqlite_file&quot;</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;SQLite file does not exist&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_file</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sqlite_file&quot;</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_user&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_user</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_user&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide a MySQL user&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_password&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_password&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_host&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_port</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_port&quot;</span><span class="p">,</span> <span class="mi">3306</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">3306</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_mariadb</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_socket&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_socket&quot;</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;MySQL socket does not exist&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_socket</span> <span class="o">=</span> <span class="n">realpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_socket&quot;</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_host</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_port</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_socket</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_tables</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sqlite_tables&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exclude_sqlite_tables</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exclude_sqlite_tables&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_views_as_tables</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sqlite_views_as_tables&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_tables</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclude_sqlite_tables</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide either sqlite_tables or exclude_sqlite_tables, not both&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_tables</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclude_sqlite_tables</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_without_foreign_keys</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_without_foreign_keys</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;without_foreign_keys&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_ssl_disabled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_ssl_disabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Expect an integer chunk size; normalize to None when unset/invalid or &lt;= 0</span>
        <span class="n">_chunk</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chunk&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span> <span class="o">=</span> <span class="n">_chunk</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_chunk</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_chunk</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quiet&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_logger</span><span class="p">(</span><span class="n">log_file</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">quiet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_database</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_database&quot;</span><span class="p">,</span> <span class="s2">&quot;transfer&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;transfer&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_insert_method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_insert_method&quot;</span><span class="p">,</span> <span class="s2">&quot;IGNORE&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_insert_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MYSQL_INSERT_METHOD</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_insert_method</span> <span class="o">=</span> <span class="s2">&quot;IGNORE&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_truncate_tables</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_truncate_tables&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_integer_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_integer_type&quot;</span><span class="p">,</span> <span class="s2">&quot;INT(11)&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_string_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_string_type&quot;</span><span class="p">,</span> <span class="s2">&quot;VARCHAR(255)&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_text_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_text_type&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_text_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MYSQL_TEXT_COLUMN_TYPES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_text_type</span> <span class="o">=</span> <span class="s2">&quot;TEXT&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_charset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_charset&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8mb4&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;utf8mb4&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_collation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_collation&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">CharacterSet</span><span class="p">()</span><span class="o">.</span><span class="n">get_default_collation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_charset</span><span class="o">.</span><span class="n">lower</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_collation&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_collation</span> <span class="o">==</span> <span class="s2">&quot;utf8mb4_0900_ai_ci&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_collation</span> <span class="o">=</span> <span class="s2">&quot;utf8mb4_unicode_ci&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_duplicate_keys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ignore_duplicate_keys&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use_fulltext</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;use_fulltext&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_with_rowid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;with_rowid&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>

        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">Decimal</span><span class="p">,</span> <span class="n">adapt_decimal</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;DECIMAL&quot;</span><span class="p">,</span> <span class="n">convert_decimal</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="n">timedelta</span><span class="p">,</span> <span class="n">adapt_timedelta</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="n">convert_date</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;TIME&quot;</span><span class="p">,</span> <span class="n">convert_timedelta</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">realpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_file</span><span class="p">),</span> <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite</span><span class="o">.</span><span class="n">create_collation</span><span class="p">(</span><span class="s2">&quot;unicase&quot;</span><span class="p">,</span> <span class="n">unicase_compare</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sqlite_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_table_xinfo_support</span> <span class="o">=</span> <span class="n">check_sqlite_table_xinfo_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_version</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_jsonb_support</span> <span class="o">=</span> <span class="n">check_sqlite_jsonb_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_version</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_create_tables</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_create_tables&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_transfer_data</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mysql_transfer_data&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_transfer_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_create_tables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to continue without transferring data or creating tables!&quot;</span><span class="p">)</span>

        <span class="n">connection_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_user</span><span class="p">,</span>
            <span class="s2">&quot;use_pure&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;charset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_charset</span><span class="p">,</span>
            <span class="s2">&quot;collation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_collation</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_password</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">connection_args</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_password</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">connection_args</span><span class="p">[</span><span class="s2">&quot;unix_socket&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_socket</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">connection_args</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_host</span>
            <span class="n">connection_args</span><span class="p">[</span><span class="s2">&quot;port&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_port</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_ssl_disabled</span><span class="p">:</span>
                <span class="n">connection_args</span><span class="p">[</span><span class="s2">&quot;ssl_disabled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_mysql_connection</span> <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">connection_args</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_mysql_connection</span><span class="p">,</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">MySQLConnection</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span> <span class="o">=</span> <span class="n">_mysql_connection</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Unable to connect to MySQL&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&quot;Unable to connect to MySQL&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">prepared</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_database</span>
            <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_DB_ERROR</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_database</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="k">raise</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mysql_version</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_mariadb</span> <span class="o">=</span> <span class="s2">&quot;-mariadb&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_json_support</span> <span class="o">=</span> <span class="n">check_mysql_json_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_fulltext_support</span> <span class="o">=</span> <span class="n">check_mysql_fulltext_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allow_expr_defaults</span> <span class="o">=</span> <span class="n">check_mysql_expression_defaults_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allow_current_ts_dt</span> <span class="o">=</span> <span class="n">check_mysql_current_timestamp_datetime_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_allow_fsp</span> <span class="o">=</span> <span class="n">check_mysql_fractional_seconds_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_fulltext</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_fulltext_support</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Your MySQL version does not support InnoDB FULLTEXT indexes!&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_logger</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">log_file</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;os.PathLike[t.Any]&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">:</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(levelname)-8s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">screen_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">stdout</span><span class="p">)</span>
            <span class="n">screen_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">screen_handler</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">log_file</span><span class="p">:</span>
            <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">realpath</span><span class="p">(</span><span class="n">log_file</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
            <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">logger</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_mysql_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SHOW VARIABLES LIKE &#39;version&#39;&quot;</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;MySQL failed checking for InnoDB version&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;MySQL failed checking for InnoDB version&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;MySQL failed checking for InnoDB version: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">err</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sqlite_version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT sqlite_version()&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;SQLite failed checking for InnoDB version: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">err</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_sqlite_quote_ident</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a SQLite identifier with internal quotes escaped.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_table_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch SQLite PRAGMA table information for a table.&quot;&quot;&quot;</span>
        <span class="n">quoted_table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="n">pragma</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;table_xinfo&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_table_xinfo_support</span> <span class="k">else</span> <span class="s2">&quot;table_info&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PRAGMA </span><span class="si">{</span><span class="n">pragma</span><span class="si">}</span><span class="s1">(&quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_declared_type_is_jsonb</span><span class="p">(</span><span class="n">column_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True when a SQLite column is declared as JSONB.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">column_type</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JSONB&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_table_primary_key_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return visible primary key columns ordered by their PK sequence.&quot;&quot;&quot;</span>
        <span class="n">primary_key_rows</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">column</span>
                <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_table_info</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">column</span><span class="p">:</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">primary_key_rows</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_sqlite_table_has_rowid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">quoted_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SELECT rowid FROM &quot;</span><span class="si">{</span><span class="n">quoted_table</span><span class="si">}</span><span class="s1">&quot; LIMIT 1&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_database</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE DATABASE IF NOT EXISTS `</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_database</span><span class="si">}</span><span class="s2">`</span>
<span class="s2">                DEFAULT CHARACTER SET </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_charset</span><span class="si">}</span>
<span class="s2">                DEFAULT COLLATE </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_collation</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">prepared</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># pylint: disable=W0201</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;MySQL failed creating databse </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_database</span><span class="p">,</span>
                <span class="n">err</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_valid_column_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">COLUMN_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">column_type</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_base_mysql_column_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">stripped</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">column_type</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stripped</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_valid_column_type</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stripped</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_column_type_supports_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">allow_expr_defaults</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">base_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">normalized</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">normalized</span> <span class="o">==</span> <span class="s2">&quot;GEOMETRY&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">normalized</span> <span class="ow">in</span> <span class="n">MYSQL_BLOB_COLUMN_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">normalized</span> <span class="ow">in</span> <span class="n">MYSQL_TEXT_COLUMN_TYPES_WITH_JSON</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">allow_expr_defaults</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_sql_expression</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">]:</span>
        <span class="n">stripped</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stripped</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dialect</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">sqlglot</span><span class="o">.</span><span class="n">parse_one</span><span class="p">(</span><span class="n">stripped</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="n">dialect</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlglot_errors</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_textual_default</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">default_sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">allow_expr_defaults</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">is_mariadb</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalise textual DEFAULT expressions and wrap for MySQL via sqlglot.&quot;&quot;&quot;</span>
        <span class="n">stripped</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">default_sql</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stripped</span> <span class="ow">or</span> <span class="n">stripped</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stripped</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_expr_defaults</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">stripped</span>

        <span class="n">expr</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_sql_expression</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_mariadb</span> <span class="ow">or</span> <span class="n">stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">stripped</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">stripped</span><span class="si">}</span><span class="s2">)&quot;</span>

        <span class="n">formatted</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;mysql&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_mariadb</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">formatted</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Paren</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">formatted</span>

        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">Paren</span><span class="p">(</span><span class="n">this</span><span class="o">=</span><span class="n">expr</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">wrapped</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;mysql&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_translate_type_from_sqlite_to_mysql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">normalized</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_sqlite_column_type</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">normalized</span> <span class="ow">and</span> <span class="n">normalized</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="n">column_type</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalised SQLite column type </span><span class="si">%r</span><span class="s2"> -&gt; </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">column_type</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_type_from_sqlite_to_mysql_legacy</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_type_from_sqlite_to_mysql_legacy</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_sqlite_column_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">clean_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">column_type</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clean_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">normalized_for_parse</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">clean_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;UNSIGNED BIG INT&quot;</span><span class="p">,</span> <span class="s2">&quot;BIGINT UNSIGNED&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">sqlglot</span><span class="o">.</span><span class="n">parse_one</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT CAST(NULL AS </span><span class="si">{</span><span class="n">normalized_for_parse</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="s2">&quot;sqlite&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlglot_errors</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
            <span class="c1"># Retry: strip UNSIGNED to aid parsing; we&#39;ll re-attach it below if present.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">no_unsigned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bUNSIGNED\b&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">normalized_for_parse</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="n">sqlglot</span><span class="o">.</span><span class="n">parse_one</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SELECT CAST(NULL AS </span><span class="si">{</span><span class="n">no_unsigned</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="s2">&quot;sqlite&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlglot_errors</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">cast</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Cast</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">exp</span><span class="o">.</span><span class="n">Cast</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cast</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cast</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">DataType</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">params</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">expr_param</span> <span class="ow">in</span> <span class="n">cast</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">expressions</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">value_expr</span> <span class="o">=</span> <span class="n">expr_param</span><span class="o">.</span><span class="n">this</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr_param</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">DataTypeParam</span><span class="p">)</span> <span class="k">else</span> <span class="n">expr_param</span>
            <span class="k">if</span> <span class="n">value_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value_expr</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;mysql&quot;</span><span class="p">))</span>

        <span class="n">base_match</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_column_type</span><span class="p">(</span><span class="n">clean_type</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">base_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">base_match</span> <span class="k">else</span> <span class="n">clean_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="n">normalized</span> <span class="o">=</span> <span class="n">base</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">normalized</span> <span class="o">+=</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;UNSIGNED&quot;</span> <span class="ow">in</span> <span class="n">clean_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;UNSIGNED&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">normalized</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">normalized</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">normalized</span><span class="si">}</span><span class="s2"> UNSIGNED&quot;</span>

        <span class="k">return</span> <span class="n">normalized</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_translate_type_from_sqlite_to_mysql_legacy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This could be optimized even further, however is seems adequate.&quot;&quot;&quot;</span>
        <span class="n">full_column_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">column_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">unsigned</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMN_UNSIGNED_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">full_column_type</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">match</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_column_type</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">column_type</span><span class="si">}</span><span class="s1">&quot; is not a valid column_type!&#39;</span><span class="p">)</span>

        <span class="n">data_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;CLOB&quot;</span><span class="p">,</span> <span class="s2">&quot;STRING&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_text_type</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;CHARACTER&quot;</span><span class="p">,</span> <span class="s2">&quot;NCHAR&quot;</span><span class="p">,</span> <span class="s2">&quot;NATIVE CHARACTER&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="s2">&quot;CHAR&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;VARYING CHARACTER&quot;</span><span class="p">,</span> <span class="s2">&quot;NVARCHAR&quot;</span><span class="p">,</span> <span class="s2">&quot;VARCHAR&quot;</span><span class="p">}:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_string_type</span> <span class="ow">in</span> <span class="n">MYSQL_TEXT_COLUMN_TYPES</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_string_type</span>
            <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_string_type</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_column_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_string_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">length</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;UNSIGNED BIG INT&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;BIGINT</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="si">}</span><span class="s2"> UNSIGNED&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;TINYINT&quot;</span><span class="p">,</span> <span class="s2">&quot;INT1&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TINYINT</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;SMALLINT&quot;</span><span class="p">,</span> <span class="s2">&quot;INT2&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;SMALLINT</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;MEDIUMINT&quot;</span><span class="p">,</span> <span class="s2">&quot;INT3&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;MEDIUMINT</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;INT4&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;INT</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;BIGINT&quot;</span><span class="p">,</span> <span class="s2">&quot;INT8&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;BIGINT</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;INT64&quot;</span><span class="p">,</span> <span class="s2">&quot;NUMERIC&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;NUMERIC&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_type_precision_and_scale</span><span class="p">(</span><span class="n">full_column_type</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;DECIMAL</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_precision_and_scale</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;BIGINT</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span><span class="w"> </span><span class="mi">19</span><span class="p">)</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span> <span class="s2">&quot;INT&quot;</span><span class="p">)):</span>
            <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">length</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;UNSIGNED&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_integer_type</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_integer_type</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_integer_type</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_column_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_integer_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;UNSIGNED&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_integer_type</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}{</span><span class="n">length</span><span class="si">}</span><span class="s2"> UNSIGNED&quot;</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}{</span><span class="n">length</span><span class="si">}{</span><span class="s1">&#39; UNSIGNED&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="s2">&quot;TINYINT(1)&quot;</span>
        <span class="k">if</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;REAL&quot;</span><span class="p">,</span> <span class="s2">&quot;DOUBLE&quot;</span><span class="p">,</span> <span class="s2">&quot;FLOAT&quot;</span><span class="p">,</span> <span class="s2">&quot;DECIMAL&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="s2">&quot;FIXED&quot;</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">full_column_type</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s2">&quot;JSONB&quot;</span> <span class="ow">or</span> <span class="n">data_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JSONB&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;JSON&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_json_support</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_text_type</span>
        <span class="k">if</span> <span class="n">data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MYSQL_COLUMN_TYPES</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_string_type</span>
        <span class="k">return</span> <span class="n">full_column_type</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_strip_wrapping_parentheses</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove one or more layers of *fully wrapping* parentheses around an expression.</span>

<span class="sd">        Only strip if the matching &#39;)&#39; for the very first &#39;(&#39; is the final character</span>
<span class="sd">        of the string. This avoids corrupting expressions like &quot;(a) + (b)&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">):</span>
            <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">match_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span>
            <span class="n">ch</span><span class="p">:</span> <span class="nb">str</span>
            <span class="c1"># Find the matching &#39;)&#39; for the &#39;(&#39; at index 0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s2">&quot;)&quot;</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">match_idx</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
            <span class="c1"># Only strip if the match closes at the very end</span>
            <span class="k">if</span> <span class="n">match_idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">match_idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c1"># continue to try stripping more fully-wrapping layers</span>
                <span class="k">continue</span>
            <span class="c1"># Not a fully-wrapped expression; stop</span>
            <span class="k">break</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_translate_default_for_mysql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Translate SQLite DEFAULT expression to a MySQL-compatible one for common cases.</span>

<span class="sd">        Returns a string suitable to append after &quot;DEFAULT &quot;, without the word itself.</span>
<span class="sd">        Keeps literals as-is, maps `CURRENT_*`/`datetime(&#39;now&#39;)`/`strftime(...,&#39;now&#39;)` to</span>
<span class="sd">        the appropriate MySQL `CURRENT_*` functions, preserves fractional seconds if the</span>
<span class="sd">        column type declares a precision, and normalizes booleans to 0/1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">default</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">raw</span>

        <span class="n">s</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_wrapping_parentheses</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
        <span class="n">u</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">sqlite_current_ts_match</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_CURRENT_TS_FUNC</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">sqlite_current_ts_func</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sqlite_current_ts_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">sqlite_current_ts_match</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># NULL passthrough</span>
        <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;NULL&quot;</span>

        <span class="c1"># Determine base data type</span>
        <span class="n">match</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_valid_column_type</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="n">base</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="n">column_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="c1"># TIMESTAMP: allow CURRENT_TIMESTAMP across versions; preserve FSP only if supported</span>
        <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_TS</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_NOW_FUNC</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">))</span>
            <span class="ow">or</span> <span class="n">sqlite_current_ts_func</span> <span class="o">==</span> <span class="s2">&quot;datetime&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRFTIME_NOW</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">len_match</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMN_LENGTH_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
            <span class="n">fsp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_fsp</span> <span class="ow">and</span> <span class="n">len_match</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">len_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">fsp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;utc&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;UTC_TIMESTAMP</span><span class="si">{</span><span class="n">fsp</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;CURRENT_TIMESTAMP</span><span class="si">{</span><span class="n">fsp</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># DATETIME: require server support, otherwise omit the DEFAULT</span>
        <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;DATETIME&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_TS</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_NOW_FUNC</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">))</span>
            <span class="ow">or</span> <span class="n">sqlite_current_ts_func</span> <span class="o">==</span> <span class="s2">&quot;datetime&quot;</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRFTIME_NOW</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_current_ts_dt</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>
            <span class="n">len_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMN_LENGTH_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
            <span class="n">fsp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_fsp</span> <span class="ow">and</span> <span class="n">len_match</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">len_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">fsp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;utc&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;UTC_TIMESTAMP</span><span class="si">{</span><span class="n">fsp</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;CURRENT_TIMESTAMP</span><span class="si">{</span><span class="n">fsp</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># DATE</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;DATE&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_DATE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_TS</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># map CURRENT_TIMESTAMP  CURRENT_DATE for DATE</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_NOW_FUNC</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">))</span>
                <span class="ow">or</span> <span class="n">sqlite_current_ts_func</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRFTIME_NOW</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_expr_defaults</span>
        <span class="p">):</span>
            <span class="c1"># Too old for expression defaults on DATE  fall back</span>
            <span class="k">return</span> <span class="s2">&quot;CURRENT_DATE&quot;</span>

        <span class="c1"># TIME</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TIME&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_TIME</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_TS</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># map CURRENT_TIMESTAMP  CURRENT_TIME for TIME</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SQLITE_NOW_FUNC</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">))</span>
                <span class="ow">or</span> <span class="n">sqlite_current_ts_func</span> <span class="o">==</span> <span class="s2">&quot;time&quot;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">STRFTIME_NOW</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_expr_defaults</span>
        <span class="p">):</span>
            <span class="c1"># Too old for expression defaults on TIME  fall back</span>
            <span class="n">len_match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMN_LENGTH_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
            <span class="n">fsp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_fsp</span> <span class="ow">and</span> <span class="n">len_match</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">len_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;()&quot;</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">fsp</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;UTC_TIME</span><span class="si">{</span><span class="n">fsp</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="s2">&quot;utc&quot;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;CURRENT_TIME</span><span class="si">{</span><span class="n">fsp</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Booleans (store as 0/1)</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">}</span> <span class="ow">or</span> <span class="n">base</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TINYINT&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;TRUE&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;TRUE&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;TRUE&quot;&#39;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="s2">&quot;1&quot;</span>
            <span class="k">if</span> <span class="n">u</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;FALSE&quot;</span><span class="p">,</span> <span class="s2">&quot;&#39;FALSE&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;FALSE&quot;&#39;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="s2">&quot;0&quot;</span>

        <span class="c1"># Numeric literals (possibly wrapped)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUMERIC_LITERAL_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="c1"># Quoted strings and hex blobs pass through as-is</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;X&#39;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="c1"># Fallback: return stripped expression (MySQL 8.0.13+ allows expression defaults)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_expr_defaults</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">sqlglot</span><span class="o">.</span><span class="n">parse_one</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="s2">&quot;sqlite&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlglot_errors</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span>

            <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_sqlite_view_functions</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;mysql&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">sqlglot_errors</span><span class="o">.</span><span class="n">SqlglotError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span>

        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_column_type_length</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">COLUMN_LENGTH_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">suffix</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_column_type_precision_and_scale</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">suffix</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">COLUMN_PRECISION_AND_SCALE_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">suffix</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_translate_strftime_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fmt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">converted</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">sqlglot_format_time</span><span class="p">(</span>
            <span class="n">fmt</span><span class="p">,</span>
            <span class="n">SQLGLOT_MYSQL_INVERSE_TIME_MAPPING</span><span class="p">,</span>
            <span class="n">SQLGLOT_MYSQL_INVERSE_TIME_TRIE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">converted</span> <span class="ow">or</span> <span class="n">fmt</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_fetch_sqlite_master_rows</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">object_types</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">include_sql</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">object_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">columns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include_sql</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;sql&quot;</span><span class="p">)</span>

        <span class="n">object_placeholders</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_types</span><span class="p">))</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT {columns}</span>
<span class="sd">            FROM sqlite_master</span>
<span class="sd">            WHERE type IN ({object_types})</span>
<span class="sd">            AND name NOT LIKE &#39;sqlite_%&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span>
                <span class="n">object_types</span><span class="o">=</span><span class="n">object_placeholders</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">object_types</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_tables</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; AND name IN (</span><span class="si">{names}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">names</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_tables</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_tables</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclude_sqlite_tables</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">+=</span> <span class="s2">&quot; AND name NOT IN (</span><span class="si">{names}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">names</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;?&quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclude_sqlite_tables</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exclude_sqlite_tables</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_translate_sqlite_view_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">view_sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">safe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">view_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expression</span> <span class="o">=</span> <span class="n">sqlglot</span><span class="o">.</span><span class="n">parse_one</span><span class="p">(</span><span class="n">view_sql</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="s2">&quot;sqlite&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlglot_errors</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to parse SQLite view </span><span class="si">{</span><span class="n">view_name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

        <span class="n">expression</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">expression</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;this&quot;</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">to_identifier</span><span class="p">(</span><span class="n">safe_name</span><span class="p">))</span>

        <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rewrite_sqlite_view_functions</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="s2">&quot;mysql&quot;</span><span class="p">,</span> <span class="n">identify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlglot_errors</span><span class="o">.</span><span class="n">SqlglotError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to render MySQL view </span><span class="si">{</span><span class="n">view_name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_rewrite_sqlite_view_functions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_is_now_literal</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_string</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">this</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;now&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_extract_modifier</span><span class="p">(</span><span class="n">arguments</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">modifier</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_string</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">this</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;utc&quot;</span><span class="p">,</span> <span class="s2">&quot;localtime&quot;</span><span class="p">}:</span>
                        <span class="n">modifier</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">return</span> <span class="n">modifier</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_current_datetime_expression</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">modifier</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">modifier</span> <span class="o">==</span> <span class="s2">&quot;utc&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">UtcTimestamp</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;DATE&quot;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">Anonymous</span><span class="p">(</span><span class="n">this</span><span class="o">=</span><span class="s2">&quot;UTC_DATE&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">UtcTime</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">CurrentTimestamp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;DATE&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">CurrentDate</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">CurrentTime</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Anonymous</span><span class="p">):</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">expressions</span> <span class="ow">or</span> <span class="p">()</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span> <span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;TIME&quot;</span><span class="p">}</span> <span class="ow">and</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">_is_now_literal</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">modifier</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">_extract_modifier</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">_current_datetime_expression</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">modifier</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;STRFTIME&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_is_now_literal</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">mysql_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_translate_strftime_format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">this</span><span class="p">))</span>
                <span class="c1"># Optional modifiers follow the &#39;now&#39; literal.</span>
                <span class="n">modifier</span> <span class="o">=</span> <span class="n">_extract_modifier</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">TimeToStr</span><span class="p">(</span>
                    <span class="n">this</span><span class="o">=</span><span class="n">_current_datetime_expression</span><span class="p">(</span><span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span> <span class="n">modifier</span><span class="p">),</span>
                    <span class="nb">format</span><span class="o">=</span><span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">mysql_format</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">TimeToStr</span><span class="p">):</span>
            <span class="n">fmt</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span>
            <span class="n">inner</span><span class="p">:</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">this</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">TsOrDsToTimestamp</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner</span><span class="o">.</span><span class="n">this</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">inner</span><span class="o">.</span><span class="n">this</span><span class="o">.</span><span class="n">is_string</span>
                <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">inner</span><span class="o">.</span><span class="n">this</span><span class="o">.</span><span class="n">this</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;now&quot;</span>
            <span class="p">):</span>
                <span class="n">mysql_format</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_translate_strftime_format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">this</span><span class="p">))</span>
                <span class="n">extra_args</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">TsOrDsToTimestamp</span><span class="p">):</span>
                    <span class="n">extra_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">value</span>
                        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inner</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;this&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">exp</span><span class="o">.</span><span class="n">Expression</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="s2">&quot;expressions&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="n">extra_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">inner</span><span class="o">.</span><span class="n">expressions</span><span class="p">)</span>
                <span class="n">modifier</span> <span class="o">=</span> <span class="n">_extract_modifier</span><span class="p">(</span><span class="n">extra_args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">exp</span><span class="o">.</span><span class="n">TimeToStr</span><span class="p">(</span>
                    <span class="n">this</span><span class="o">=</span><span class="n">_current_datetime_expression</span><span class="p">(</span><span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span> <span class="n">modifier</span><span class="p">),</span>
                    <span class="nb">format</span><span class="o">=</span><span class="n">exp</span><span class="o">.</span><span class="n">Literal</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">mysql_format</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_mysql_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">view_sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">safe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">view_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP TABLE IF EXISTS `</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_TABLE_ERROR</span><span class="p">,</span>
                <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_WRONG_OBJECT</span><span class="p">,</span>
                <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_UNKNOWN_TABLE</span><span class="p">,</span>
            <span class="p">}:</span>
                <span class="k">raise</span>

        <span class="c1"># Ensure a stale VIEW does not block creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP VIEW IF EXISTS `</span><span class="si">{</span><span class="n">safe_name</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating view </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">safe_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">view_sql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">transfer_rowid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">skip_default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">primary_keys</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CREATE TABLE IF NOT EXISTS `</span><span class="si">{</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="si">}</span><span class="s2">` ( &quot;</span>

        <span class="k">if</span> <span class="n">transfer_rowid</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; `rowid` BIGINT NOT NULL, &quot;</span>

        <span class="n">quoted_table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_table_xinfo_support</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PRAGMA table_xinfo(&quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PRAGMA table_info(&quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>

        <span class="n">rows</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">compound_primary_key</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="kc">True</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">column</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">mysql_safe_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_type_from_sqlite_to_mysql</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>

            <span class="c1"># The &quot;hidden&quot; value is 0 for visible columns, 1 for &quot;hidden&quot; columns,</span>
            <span class="c1"># 2 for computed virtual columns and 3 for computed stored columns.</span>
            <span class="c1"># Read more on hidden columns here https://www.sqlite.org/pragma.html#pragma_table_xinfo</span>
            <span class="k">if</span> <span class="s2">&quot;hidden&quot;</span> <span class="ow">in</span> <span class="n">column</span> <span class="ow">and</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;hidden&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">auto_increment</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">column</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">column_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;INT&quot;</span><span class="p">,</span> <span class="s2">&quot;BIGINT&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">compound_primary_key</span>
            <span class="p">)</span>

            <span class="n">allow_expr_defaults</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_allow_expr_defaults&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">is_mariadb</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_is_mariadb&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">base_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_mysql_column_type</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>

            <span class="c1"># Build DEFAULT clause safely (preserve falsy defaults like 0/&#39;&#39;)</span>
            <span class="n">default_clause</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">skip_default</span>
                <span class="ow">and</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;dflt_value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_type_supports_default</span><span class="p">(</span><span class="n">base_type</span><span class="p">,</span> <span class="n">allow_expr_defaults</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">auto_increment</span>
            <span class="p">):</span>
                <span class="n">td</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_default_for_mysql</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;dflt_value&quot;</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">td</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">stripped_td</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">base_type</span> <span class="ow">in</span> <span class="n">MYSQL_TEXT_COLUMN_TYPES_WITH_JSON</span> <span class="ow">and</span> <span class="n">stripped_td</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;NULL&quot;</span><span class="p">:</span>
                        <span class="n">td</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_textual_default</span><span class="p">(</span><span class="n">stripped_td</span><span class="p">,</span> <span class="n">allow_expr_defaults</span><span class="p">,</span> <span class="n">is_mariadb</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">td</span> <span class="o">=</span> <span class="n">stripped_td</span>
                    <span class="n">default_clause</span> <span class="o">=</span> <span class="s2">&quot;DEFAULT &quot;</span> <span class="o">+</span> <span class="n">td</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot; `</span><span class="si">{name}</span><span class="s2">` </span><span class="si">{type}</span><span class="s2"> </span><span class="si">{notnull}</span><span class="s2"> </span><span class="si">{default}</span><span class="s2"> </span><span class="si">{auto_increment}</span><span class="s2">, &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">mysql_safe_name</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">column_type</span><span class="p">,</span>
                <span class="n">notnull</span><span class="o">=</span><span class="s2">&quot;NOT NULL&quot;</span> <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;notnull&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;NULL&quot;</span><span class="p">,</span>
                <span class="n">auto_increment</span><span class="o">=</span><span class="s2">&quot;AUTO_INCREMENT&quot;</span> <span class="k">if</span> <span class="n">auto_increment</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="n">default_clause</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;pk&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">primary_key</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;column&quot;</span><span class="p">:</span> <span class="n">mysql_safe_name</span><span class="p">,</span>
                    <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="c1"># In case we have a non-numeric primary key</span>
                <span class="k">if</span> <span class="n">column_type</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="n">MYSQL_TEXT_COLUMN_TYPES_WITH_JSON</span> <span class="o">+</span> <span class="n">MYSQL_BLOB_COLUMN_TYPES</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="n">column_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;CHAR&quot;</span><span class="p">,</span> <span class="s2">&quot;VARCHAR&quot;</span><span class="p">)):</span>
                    <span class="n">primary_key</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_type_length</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                <span class="n">primary_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">primary_key</span><span class="p">)</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">primary_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="s2">&quot;, PRIMARY KEY (</span><span class="si">{columns}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;`</span><span class="si">{column}</span><span class="s2">`</span><span class="si">{length}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">primary_key</span><span class="p">)</span> <span class="k">for</span> <span class="n">primary_key</span> <span class="ow">in</span> <span class="n">primary_keys</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">transfer_rowid</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, CONSTRAINT `</span><span class="si">{</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_rowid` UNIQUE (`rowid`)&quot;</span>

        <span class="n">sql</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; ) ENGINE=InnoDB DEFAULT CHARSET=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_charset</span><span class="si">}</span><span class="s2"> COLLATE=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_collation</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_INVALID_DEFAULT</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">skip_default</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;MySQL failed creating table </span><span class="si">%s</span><span class="s2"> with DEFAULT values: </span><span class="si">%s</span><span class="s2">. Retrying without DEFAULT values ...&quot;</span><span class="p">,</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                    <span class="n">err</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">transfer_rowid</span><span class="p">,</span> <span class="n">skip_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;MySQL failed creating table </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                    <span class="n">err</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_truncate_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            SELECT `TABLE_NAME`</span>
<span class="sd">            FROM `INFORMATION_SCHEMA`.`TABLES`</span>
<span class="sd">            WHERE `TABLE_SCHEMA` = %s</span>
<span class="sd">            AND `TABLE_NAME` = %s</span>
<span class="sd">            LIMIT 1</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_database</span><span class="p">,</span> <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Truncating table </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TRUNCATE TABLE `</span><span class="si">{</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span><span class="si">}</span><span class="s2">`&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">quoted_table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PRAGMA table_info(&quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
        <span class="n">table_columns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">column</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">table_columns</span><span class="p">[</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">column</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PRAGMA index_list(&quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
        <span class="n">indices</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pk&quot;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">quoted_index_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PRAGMA index_info(&quot;</span><span class="si">{</span><span class="n">quoted_index_name</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>
            <span class="n">index_infos</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>

            <span class="n">index_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;UNIQUE&quot;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;INDEX&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">table_columns</span><span class="p">[</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">MYSQL_TEXT_COLUMN_TYPES_WITH_JSON</span>
                    <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_fulltext</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_fulltext_support</span><span class="p">:</span>
                        <span class="c1"># Use fulltext if requested and available</span>
                        <span class="n">index_type</span> <span class="o">=</span> <span class="s2">&quot;FULLTEXT&quot;</span>
                        <span class="n">index_columns</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">`&#39;</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Limit the max TEXT field index length to 255</span>
                        <span class="n">index_columns</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="s2">&quot;`</span><span class="si">{column}</span><span class="s2">`</span><span class="si">{length}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">column</span><span class="o">=</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                                <span class="n">length</span><span class="o">=</span><span class="p">(</span>
                                    <span class="s2">&quot;(255)&quot;</span>
                                    <span class="k">if</span> <span class="n">table_columns</span><span class="p">[</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">MYSQL_TEXT_COLUMN_TYPES_WITH_JSON</span>
                                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">column_list</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">:</span>
                        <span class="n">index_length</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="c1"># Limit the max BLOB field index length to 255</span>
                        <span class="k">if</span> <span class="n">table_columns</span><span class="p">[</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">MYSQL_BLOB_COLUMN_TYPES</span><span class="p">:</span>
                            <span class="n">index_length</span> <span class="o">=</span> <span class="s2">&quot;(255)&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">suffix</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Match</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLUMN_LENGTH_PATTERN</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                                <span class="n">table_columns</span><span class="p">[</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">suffix</span><span class="p">:</span>
                                <span class="n">index_length</span> <span class="o">=</span> <span class="n">suffix</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">column_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;`</span><span class="si">{</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">`</span><span class="si">{</span><span class="n">index_length</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">index_columns</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_list</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Failed adding index to column &quot;%s&quot; in table %s: Column not found!&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_index</span><span class="p">(</span>
                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                    <span class="n">index_type</span><span class="o">=</span><span class="n">index_type</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">index_columns</span><span class="o">=</span><span class="n">index_columns</span><span class="p">,</span>
                    <span class="n">index_infos</span><span class="o">=</span><span class="n">index_infos</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_FT_COLUMN</span> <span class="ow">and</span> <span class="n">index_type</span> <span class="o">==</span> <span class="s2">&quot;FULLTEXT&quot;</span><span class="p">:</span>
                    <span class="c1"># handle bad FULLTEXT index</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_index</span><span class="p">(</span>
                        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                        <span class="n">index_type</span><span class="o">=</span><span class="s2">&quot;UNIQUE&quot;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;INDEX&quot;</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">index_columns</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="s2">&quot;`</span><span class="si">{column}</span><span class="s2">`</span><span class="si">{length}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">column</span><span class="o">=</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                                <span class="n">length</span><span class="o">=</span><span class="p">(</span>
                                    <span class="s2">&quot;(255)&quot;</span>
                                    <span class="k">if</span> <span class="n">table_columns</span><span class="p">[</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">MYSQL_TEXT_COLUMN_TYPES_WITH_JSON</span>
                                    <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                                <span class="p">),</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span>
                        <span class="p">),</span>
                        <span class="n">index_infos</span><span class="o">=</span><span class="n">index_infos</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">index_columns</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">index_infos</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">],</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">index_iteration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            ALTER TABLE `{table}`</span>
<span class="sd">            ADD {index_type} `{name}`({columns})</span>
<span class="sd">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">table</span><span class="o">=</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="n">index_type</span><span class="o">=</span><span class="n">index_type</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">index_iteration</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span><span class="w"> </span><span class="n">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">index_iteration</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">),</span>
                <span class="n">columns</span><span class="o">=</span><span class="n">index_columns</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;Adding %s to column &quot;%s&quot; in table %s&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unique index&quot;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;unique&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
                <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_DUP_KEYNAME</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_duplicate_keys</span><span class="p">:</span>
                    <span class="c1"># handle a duplicate key name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_index</span><span class="p">(</span>
                        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span>
                        <span class="n">index_type</span><span class="o">=</span><span class="n">index_type</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">index_columns</span><span class="o">=</span><span class="n">index_columns</span><span class="p">,</span>
                        <span class="n">index_infos</span><span class="o">=</span><span class="n">index_infos</span><span class="p">,</span>
                        <span class="n">index_iteration</span><span class="o">=</span><span class="n">index_iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;Duplicate key &quot;%s&quot; in table %s detected! Trying to create new key &quot;%s_%s&quot; ...&quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                        <span class="n">index_iteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;Ignoring duplicate key &quot;%s&quot; in table %s!&quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]),</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                    <span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_DUP_ENTRY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Ignoring duplicate entry when adding index to column &quot;%s&quot; in table %s!&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_DUP_FIELDNAME</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Failed adding index to column &quot;%s&quot; in table %s: Duplicate field name! Ignoring...&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_TOO_MANY_KEYS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Failed adding index to column &quot;%s&quot; in table %s: Too many keys! Ignoring...&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_TOO_LONG_KEY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Failed adding index to column &quot;%s&quot; in table %s: Key length too long! Ignoring...&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">err</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errorcode</span><span class="o">.</span><span class="n">ER_BAD_FT_COLUMN</span><span class="p">:</span>
                <span class="c1"># handle bad FULLTEXT index</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Failed adding FULLTEXT index to column &quot;%s&quot; in table %s. Retrying without FULLTEXT ...&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;MySQL failed adding index to column &quot;%s&quot; in table %s: %s&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">index_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">index_info</span> <span class="ow">in</span> <span class="n">index_infos</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                    <span class="n">err</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_foreign_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">quoted_table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PRAGMA foreign_key_list(&quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;)&#39;</span><span class="p">)</span>

        <span class="n">foreign_keys</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">foreign_key</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">foreign_keys</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">foreign_key</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">foreign_key</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fk_id</span><span class="p">,</span> <span class="n">fk_rows</span> <span class="ow">in</span> <span class="n">foreign_keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fk_rows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">fk_row</span><span class="p">:</span> <span class="n">fk_row</span><span class="p">[</span><span class="s2">&quot;seq&quot;</span><span class="p">])</span>
            <span class="n">ref_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;table&quot;</span><span class="p">]</span>
            <span class="n">from_columns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">fk_row</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">fk_row</span> <span class="ow">in</span> <span class="n">fk_rows</span><span class="p">]</span>

            <span class="n">referenced_columns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
            <span class="n">missing_references</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fk_row</span> <span class="k">for</span> <span class="n">fk_row</span> <span class="ow">in</span> <span class="n">fk_rows</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">fk_row</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">missing_references</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_references</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fk_rows</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Skipping foreign key &quot;</span><span class="si">%s</span><span class="s1">&quot; in table </span><span class="si">%s</span><span class="s1">: partially defined reference columns.&#39;</span><span class="p">,</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;from&quot;</span><span class="p">]),</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">primary_keys</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_table_primary_key_columns</span><span class="p">(</span><span class="n">ref_table</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">primary_keys</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">primary_keys</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">from_columns</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Skipping foreign key &quot;</span><span class="si">%s</span><span class="s1">&quot; in table </span><span class="si">%s</span><span class="s1">: unable to resolve referenced primary key columns from table </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;from&quot;</span><span class="p">]),</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">ref_table</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">referenced_columns</span> <span class="o">=</span> <span class="n">primary_keys</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">referenced_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">fk_row</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">fk_row</span> <span class="ow">in</span> <span class="n">fk_rows</span><span class="p">]</span>

            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                ALTER TABLE `</span><span class="si">{table}</span><span class="s2">`</span>
<span class="s2">                ADD CONSTRAINT `</span><span class="si">{table}</span><span class="s2">_FK_</span><span class="si">{id}</span><span class="s2">_</span><span class="si">{seq}</span><span class="s2">`</span>
<span class="s2">                FOREIGN KEY (</span><span class="si">{columns}</span><span class="s2">)</span>
<span class="s2">                REFERENCES `</span><span class="si">{ref_table}</span><span class="s2">`(</span><span class="si">{ref_columns}</span><span class="s2">)</span>
<span class="s2">                ON DELETE </span><span class="si">{on_delete}</span>
<span class="s2">                ON UPDATE </span><span class="si">{on_update}</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">fk_id</span><span class="p">,</span>
                <span class="n">seq</span><span class="o">=</span><span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;seq&quot;</span><span class="p">],</span>
                <span class="n">table</span><span class="o">=</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">`&quot;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">from_columns</span><span class="p">),</span>
                <span class="n">ref_table</span><span class="o">=</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">ref_table</span><span class="p">),</span>
                <span class="n">ref_columns</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">`&quot;</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">referenced_columns</span><span class="p">),</span>
                <span class="n">on_delete</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;on_delete&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;SET DEFAULT&quot;</span> <span class="k">else</span> <span class="s2">&quot;NO ACTION&quot;</span>
                <span class="p">),</span>
                <span class="n">on_update</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;on_update&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">fk_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;on_update&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;SET DEFAULT&quot;</span> <span class="k">else</span> <span class="s2">&quot;NO ACTION&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Adding foreign key to </span><span class="si">%s</span><span class="s2">.(</span><span class="si">%s</span><span class="s2">) referencing </span><span class="si">%s</span><span class="s2">.(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">from_columns</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">ref_table</span><span class="p">),</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">referenced_columns</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;MySQL failed adding foreign key to </span><span class="si">%s</span><span class="s2">.(</span><span class="si">%s</span><span class="s2">) referencing </span><span class="si">%s</span><span class="s2">.(</span><span class="si">%s</span><span class="s2">): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">from_columns</span><span class="p">),</span>
                    <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">ref_table</span><span class="p">),</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">referenced_columns</span><span class="p">),</span>
                    <span class="n">err</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_transfer_table_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">total_records</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">total_records</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span><span class="p">)),</span> <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
                    <span class="n">sql</span><span class="p">,</span>
                    <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchmany</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span><span class="p">)),</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span>
                <span class="n">sql</span><span class="p">,</span>
                <span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(),</span>
                        <span class="n">total</span><span class="o">=</span><span class="n">total_records</span><span class="p">,</span>
                        <span class="n">disable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mysql</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<div class="viewcode-block" id="SQLite3toMySQL.transfer">
<a class="viewcode-back" href="../../sqlite3_to_mysql.html#sqlite3_to_mysql.transporter.SQLite3toMySQL.transfer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The primary and only method with which we transfer all the data.&quot;&quot;&quot;</span>
        <span class="n">table_types</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_views_as_tables</span><span class="p">:</span>
            <span class="n">table_types</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">table_types</span><span class="p">,</span> <span class="s2">&quot;view&quot;</span><span class="p">)</span>

        <span class="n">tables</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_sqlite_master_rows</span><span class="p">(</span><span class="n">table_types</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_views_as_tables</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_create_tables</span><span class="p">:</span>
            <span class="n">views</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_sqlite_master_rows</span><span class="p">((</span><span class="s2">&quot;view&quot;</span><span class="p">,),</span> <span class="n">include_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">views</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET FOREIGN_KEY_CHECKS=0&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">object_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">)</span>
                <span class="n">quoted_table_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

                <span class="c1"># check if we&#39;re transferring rowid</span>
                <span class="n">transfer_rowid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_with_rowid</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_table_has_rowid</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

                <span class="c1"># create the table</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_create_tables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">transfer_rowid</span><span class="o">=</span><span class="n">transfer_rowid</span><span class="p">)</span>

                <span class="c1"># truncate the table on request</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_truncate_tables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_truncate_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

                <span class="c1"># get the size of the data</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_transfer_data</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SELECT COUNT(*) AS total_records FROM &quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="n">total_records</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">())[</span><span class="s2">&quot;total_records&quot;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_records</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># only continue if there is anything to transfer</span>
                <span class="k">if</span> <span class="n">total_records</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># populate it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Transferring </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;view&quot;</span> <span class="k">if</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;view&quot;</span> <span class="k">else</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span>
                        <span class="n">table_name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">table_column_info</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_table_info</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
                    <span class="n">visible_columns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">table_column_info</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
                    <span class="p">]</span>
                    <span class="n">jsonb_columns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_jsonb_support</span><span class="p">:</span>
                        <span class="n">jsonb_columns</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">visible_columns</span>
                            <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_declared_type_is_jsonb</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span>
                        <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">jsonb_columns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                    <span class="n">select_parts</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">transfer_rowid</span><span class="p">:</span>
                        <span class="n">select_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rowid AS &quot;rowid&quot;&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">visible_columns</span><span class="p">:</span>
                        <span class="n">column_name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">column_name</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">quoted_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_quote_ident</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="n">jsonb_columns</span><span class="p">:</span>
                            <span class="n">select_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sqlite_jsonb_column_expression</span><span class="p">(</span><span class="n">quoted_column</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">select_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">quoted_column</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">select_parts</span><span class="p">:</span>
                        <span class="n">select_list</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">select_parts</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">select_list</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SELECT </span><span class="si">{</span><span class="n">select_list</span><span class="si">}</span><span class="s1"> FROM &quot;</span><span class="si">{</span><span class="n">quoted_table_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                    <span class="n">columns</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_cur</span><span class="o">.</span><span class="n">description</span>
                    <span class="p">]</span>
                    <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_insert_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            INSERT</span>
<span class="s2">                            INTO `</span><span class="si">{table}</span><span class="s2">` (</span><span class="si">{fields}</span><span class="s2">)</span>
<span class="s2">                            </span><span class="si">{values_clause}</span>
<span class="s2">                            ON DUPLICATE KEY UPDATE </span><span class="si">{field_updates}</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">table</span><span class="o">=</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                            <span class="n">fields</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;`</span><span class="si">{}</span><span class="s2">`, &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; ,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">columns</span><span class="p">),</span>
                            <span class="n">values_clause</span><span class="o">=</span><span class="p">(</span>
                                <span class="s2">&quot;VALUES (</span><span class="si">{placeholders}</span><span class="s2">) AS `__new__`&quot;</span>
                                <span class="k">if</span> <span class="n">check_mysql_values_alias_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="p">)</span>
                                <span class="k">else</span> <span class="s2">&quot;VALUES (</span><span class="si">{placeholders}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">placeholders</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; ,&quot;</span><span class="p">)),</span>
                            <span class="n">field_updates</span><span class="o">=</span><span class="p">(</span>
                                <span class="p">(</span><span class="s2">&quot;`</span><span class="si">{}</span><span class="s2">`=`__new__`.`</span><span class="si">{}</span><span class="s2">`, &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; ,&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">check_mysql_values_alias_support</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mysql_version</span><span class="p">)</span>
                                <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;`</span><span class="si">{}</span><span class="s2">`=`</span><span class="si">{}</span><span class="s2">`, &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; ,&quot;</span><span class="p">)</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">((</span><span class="n">column</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">))),</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                            INSERT </span><span class="si">{ignore}</span>
<span class="s2">                            INTO `</span><span class="si">{table}</span><span class="s2">` (</span><span class="si">{fields}</span><span class="s2">)</span>
<span class="s2">                            VALUES (</span><span class="si">{placeholders}</span><span class="s2">)</span>
<span class="s2">                        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ignore</span><span class="o">=</span><span class="s2">&quot;IGNORE&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_insert_method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;IGNORE&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="n">table</span><span class="o">=</span><span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                            <span class="n">fields</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;`</span><span class="si">{}</span><span class="s2">`, &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; ,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">columns</span><span class="p">),</span>
                            <span class="n">placeholders</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, &quot;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; ,&quot;</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_table_data</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span> <span class="n">total_records</span><span class="o">=</span><span class="n">total_records</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;MySQL transfer failed inserting data into </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;view&quot;</span> <span class="k">if</span> <span class="n">object_type</span> <span class="o">==</span> <span class="s2">&quot;view&quot;</span> <span class="k">else</span> <span class="s2">&quot;table&quot;</span><span class="p">,</span>
                            <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span>
                            <span class="n">err</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>

                <span class="c1"># add indices</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_create_tables</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_indices</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

                <span class="c1"># add foreign keys</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_create_tables</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_without_foreign_keys</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_foreign_keys</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite_views_as_tables</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_create_tables</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">views</span><span class="p">:</span>
                    <span class="n">view_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="n">sql_definition</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sql&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sql_definition</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Skipping view </span><span class="si">%s</span><span class="s2">: sqlite_master definition missing.&quot;</span><span class="p">,</span>
                            <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">view_name</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mysql_view_sql</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_sqlite_view_definition</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="n">sql_definition</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_create_mysql_view</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="n">mysql_view_sql</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;Failed translating view </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">view_name</span><span class="p">),</span>
                            <span class="n">err</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                            <span class="s2">&quot;MySQL failed creating view </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">safe_identifier_length</span><span class="p">(</span><span class="n">view_name</span><span class="p">),</span>
                            <span class="n">err</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># pylint: disable=W0706</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SET FOREIGN_KEY_CHECKS=1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">sqlite3-to-mysql</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">sqlite3_to_mysql</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2026, Klemen Tusar.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 9.1.0</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>